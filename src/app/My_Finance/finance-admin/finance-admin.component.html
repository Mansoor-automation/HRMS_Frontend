<!-- Loading Overlay -->
<div class="upload-loading-overlay" *ngIf="isUploading">
  <div class="loading-content">
    <div class="spinner-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
    </div>
    <h2>Uploading Employees</h2>
    <p>Please wait while we process your file...</p>
    <div class="progress-dots">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>
  </div>
</div>

<ion-content [fullscreen]="true" class="admin-dashboard ion-padding">

  <!-- ================= PAYROLL UPLOAD ================= -->
  <ion-card class="payroll-upload-card">
    <ion-card-header style="display: flex; flex-direction: column; align-items: center; text-align: center;">
      <ion-icon name="document-attach-outline" class="payroll-upload-icon"></ion-icon>
      <ion-card-title>Payroll Excel Upload</ion-card-title>
      <ion-card-subtitle>
        Upload monthly payroll data for employees
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <form class="payroll-upload-form" style="max-width: 420px; margin: 0 auto;">

        <!-- File Upload -->
        <div class="upload-row" style="flex-direction: column; align-items: flex-start; width: 100%;">
          <label for="payroll-file" class="upload-label" style="margin-bottom: 0.5rem;">
            <ion-icon name="cloud-upload-outline"></ion-icon>
            Select Excel File
          </label>
          <input id="payroll-file" type="file" accept=".xlsx,.xls" (change)="payrollFileSelected($event)"
            style="width: 100%;" />
        </div>

        <!-- Month & Year -->
        <div class="upload-row" style="width: 100%; gap: 1.5rem;">
          <div style="flex:1; display: flex; flex-direction: column;">
            <ion-label>Month</ion-label>
            <ion-input type="number" min="1" max="12" [(ngModel)]="payrollMonth" name="payrollMonth">
            </ion-input>
          </div>

          <div style="flex:1; display: flex; flex-direction: column;">
            <ion-label>Year</ion-label>
            <ion-input type="number" min="2000" max="2100" [(ngModel)]="payrollYear" name="payrollYear">
            </ion-input>
          </div>
        </div>

        <!-- Buttons -->
        <div class="upload-row" style="width: 100%; justify-content: flex-end; gap: 1rem;">
          <button ion-button color="primary" type="button" (click)="uploadPayroll()" [disabled]="payrollUploading">

            <ion-icon name="cloud-done-outline"></ion-icon>
            {{ payrollUploading ? 'Uploading...' : 'Upload Payroll' }}
          </button>

          <button ion-button color="success" type="button" (click)="generatePayroll()"
            [disabled]="payrollUploading || generatePayrollLoading">

            <ion-icon name="calculator-outline"></ion-icon>
            {{ generatePayrollLoading ? 'Generating...' : 'Generate Payroll' }}
          </button>
        </div>

        <!-- Upload Loading -->
        <div *ngIf="payrollUploading" class="upload-status">
          <ion-spinner name="crescent" color="primary"></ion-spinner>
          <span>Uploading payroll, please wait...</span>
        </div>

        <!-- Generate Loading -->
        <div *ngIf="generatePayrollLoading" class="upload-status">
          <ion-spinner name="crescent" color="success"></ion-spinner>
          <span>Generating payroll, please wait...</span>
        </div>

        <!-- Result Message -->
        <div *ngIf="generatePayrollMessage" class="upload-status" [ngClass]="{
            'success': generatePayrollMessage.includes('success'),
            'error': !generatePayrollMessage.includes('success')
          }">

          <span>{{ generatePayrollMessage }}</span>
        </div>

      </form>

      <div class="upload-note" style="justify-content: center;">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Accepted formats: .xlsx, .xls | Only Admin & HR can upload payroll</span>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- ================= EMPLOYEE LIST ================= -->
  <p class="page-header mb-8">
    <a routerLink="/admin" (click)="adminManagement()">Admin Management /</a>
    All Employees
  </p>

  <div class="top-bar">
    <h1>Employees List</h1>
    <p>Monitor and maintain employee records</p>
  </div>

  <ion-grid class="ion-no-padding">
    <ion-row>
      <ion-col size="12">
        <ion-card>

          <!-- Header -->
          <ion-card-header class="row-space-between">
            <ion-card-title>
              Employees <small>{{ allCandidates.length }}</small>
            </ion-card-title>

            <ion-searchbar *ngIf="isHR" [(ngModel)]="searchTerm" (ionInput)="loadEmployees()"
              placeholder="Search Employees" showCancelButton="never">
            </ion-searchbar>
          </ion-card-header>

          <!-- Table -->
          <ion-card-content>
            <ion-grid class="table-block">

              <!-- Header Row -->
              <ion-row class="table-header">
                <ion-col size="1">Employee ID</ion-col>
                <ion-col size="2">Name</ion-col>
                <ion-col size="2">Email</ion-col>
                <ion-col size="2">Department</ion-col>
                <ion-col size="2">Designation</ion-col>
                <ion-col size="2">Phone</ion-col>
                <ion-col size="1">Actions</ion-col>
              </ion-row>

              <!-- Employee Rows -->
              <ion-row class="table-row-list" *ngFor="let candidate of pagedCandidates">

                <ion-col size="1">
                  {{ candidate.id }}
                </ion-col>

                <ion-col size="2">
                  {{ candidate.FullName || '-' }}
                </ion-col>

                <ion-col size="2">
                  {{ candidate.WorkEmail || '-' }}
                </ion-col>

                <ion-col size="2">
                  Department
                </ion-col>

                <ion-col size="2">
                  Designation
                </ion-col>

                <ion-col size="2">
                  Phone
                </ion-col>
                <ion-col size="1" *ngIf="isHR">
                  <ion-button fill="clear" size="small" (click)="selectEmployee(candidate)"><img
                      src="../../../../assets/Icons/pencil.svg"></ion-button>
                </ion-col>
              </ion-row>

              <!-- Update Employee Profile Modal for HR -->
              <ion-modal *ngIf="isHR && selectedEmployee" [isOpen]="!!selectedEmployee"
                (didDismiss)="selectedEmployee = null" class="side-custom-popup custom-popup checkinInfo-popup">
                <ng-template>
                  <ion-content class="ion-padding">
                    <ion-title>Update Employee Profile <br>
                      (<small>{{selectedEmployee.FullName}}</small>)</ion-title>
                    <div class="form-block">
                      <!-- <ion-item>
                          <ion-label position="stacked">Reporting Manager</ion-label>
                          <ion-input [value]="selectedEmployee?.reporting_manager_name || '-'" readonly></ion-input>
                        </ion-item> -->
                      <ion-list lines="none" class="form-container">
                        <ion-item>
                          <ion-label position="stacked">Leave Plan</ion-label>
                          <ion-select [(ngModel)]="updateData.leave_plan_id" interface="popover"
                            placeholder="Select Leave Plan" toggleIcon="chevron-down" expandedIcon="chevron-up">
                            <ion-select-option *ngFor="let plan of leavePlans" [value]="plan.id">
                              {{plan.name}}
                            </ion-select-option>
                          </ion-select>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Shift Policy</ion-label>
                          <ion-select [(ngModel)]="updateData.shift_policy_id" interface="popover"
                            placeholder="Select Shift Policy" toggleIcon="chevron-down" expandedIcon="chevron-up">
                            <ion-select-option *ngFor="let policy of shiftPolicies" [value]="policy.id">
                              {{policy.name}} ({{policy.start_time}} - {{policy.end_time}})
                            </ion-select-option>
                          </ion-select>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Attendance Policy</ion-label>
                          <ion-select [(ngModel)]="updateData.attendance_policy_id" interface="popover"
                            placeholder="Select Attendance Policy" toggleIcon="chevron-down" expandedIcon="chevron-up">
                            <ion-select-option *ngFor="let policy of attendancePolicies" [value]="policy.id">
                              {{policy.name}}
                            </ion-select-option>
                          </ion-select>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Weekly Off Policy</ion-label>
                          <ion-select [(ngModel)]="updateData.weekly_off_policy_id" interface="popover"
                            placeholder="Select Weekly Off Policy" toggleIcon="chevron-down" expandedIcon="chevron-up">
                            <ion-select-option *ngFor="let policy of weeklyOffPolicies" [value]="policy.id">
                              {{policy.name}}
                            </ion-select-option>
                          </ion-select>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Pay Grade ID</ion-label>
                          <ion-input type="number" [(ngModel)]="updateData.PayGradeId"></ion-input>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">CTC</ion-label>
                          <ion-input type="number" [(ngModel)]="updateData.lpa"></ion-input>
                        </ion-item>
                      </ion-list>
                      <div class="ion-padding-top form-footer">
                        <ion-button class="primary-outline-btn" (click)="selectedEmployee = null">Cancel</ion-button>
                        <ion-button class="primary-btn" (click)="updateEmployeeProfile()">Update</ion-button>
                      </div>
                    </div>
                  </ion-content>
                </ng-template>
              </ion-modal>
              <!-- No Data -->
              <ion-row *ngIf="pagedCandidates.length === 0">
                <ion-col size="12" class="ion-text-center">
                  No employees found
                </ion-col>
              </ion-row>

            </ion-grid>

            <!-- Pagination -->
            <div class="row-right ion-padding">
              <ion-button fill="clear" (click)="prevPage()" [disabled]="currentPage === 1">
                <ion-icon name="chevron-back-outline"></ion-icon>
              </ion-button>

              <ion-text>
                Page {{ currentPage }} of {{ totalPages }}
              </ion-text>

              <ion-button fill="clear" (click)="nextPage()" [disabled]="currentPage === totalPages">
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </ion-button>
            </div>

          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

</ion-content>