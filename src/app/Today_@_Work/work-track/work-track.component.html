<ion-content class="ion-padding page-containerOn">

  <!-- ======= TOP BAR ======= -->
  <div class="top-bar">
    <div>
      <h1>Work Track</h1>
      <p>Track your daily work hours and manage timesheets</p>
    </div>
    <div class="stats-chips">
      <ion-chip color="primary">
        <ion-icon name="time-outline"></ion-icon>
        <ion-label>Today</ion-label>
      </ion-chip>
    </div>
  </div>

  <div *ngIf="hasProject == false">
    <!-- ================= CREATE TIMESHEET ================= -->
    <ion-card class="worklog-block create-card">
      <ion-card-header>
        <div class="header-content">
          <div>
            <ion-card-title>
              <ion-icon name="create-outline"></ion-icon>
              Daily Work Log
            </ion-card-title>
            <p>Track your work hours and tasks for today</p>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="workTrackForm">
          <div class="date-selector">
            <label>
              Select Date
            </label>
            <ion-input type="date" formControlName="date" [max]="today"></ion-input>
          </div>
          <ion-grid class="table-block ion-no-padding">
            <ion-row class="table-header">
              <ion-col size="2">
                <p>Time Slot</p>
              </ion-col>
              <ion-col size="8">
                <p>Task Description</p>
              </ion-col>
              <ion-col size="1">
                <p>Hours</p>
              </ion-col>
              <ion-col size="1">
                <p>Action</p>
              </ion-col>
            </ion-row>
            <div formArrayName="hours_breakdown">
              <ion-row class="table-list-row" *ngFor="let row of breakdowns.controls; let i = index"
                [formGroupName]="i">
                <ion-col size="2">
                  <ion-input formControlName="hour" placeholder="Add Time"></ion-input>
                </ion-col>
                <ion-col size="8">
                  <ion-textarea formControlName="task" placeholder="Add task details"></ion-textarea>
                </ion-col>
                <ion-col size="1">
                  <ion-input type="number" formControlName="hours" placeholder="1" (ionChange)="onHoursChange(i)">
                  </ion-input>
                </ion-col>
                <ion-col size="1">
                  <ion-button fill="clear" color="danger" size="small" *ngIf="!(breakdowns.length>1)"
                    (click)="removeRow(i)" disabled>
                    <ion-img src="../../../assets/delete.svg"></ion-img>
                  </ion-button>
                  <ion-button fill="clear" color="danger" size="small" *ngIf="breakdowns.length > 1"
                    (click)="removeRow(i)">
                    <ion-img src="../../../assets/delete.svg"></ion-img>
                  </ion-button>
                </ion-col>
              </ion-row>
            </div>
            <!-- TOTAL -->
            <div class="total-hours-card">
              <div class="total-content">
                <ion-icon name="time" color="primary"></ion-icon>
                <span class="total-label">Total Hours</span>
              </div>
              <ion-badge class="total-badge">{{ calculateTotalHours() }} hrs</ion-badge>
            </div>
            <ion-row>
              <ion-col size="12" class="row-right pr-30">
                <ion-button class="primary-outline-btn mr-8" (click)="addRow()">
                  + Add Time Slot
                </ion-button>
                <!-- SUBMIT -->
                <ion-button class="primary-btn" (click)="submit()" [disabled]="loading">
                  {{ loading ? 'Submitting...' : 'Submit Work Log' }}
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>





          <!-- NOTES -->
          <!-- <div class="notes-section">
            <label>
              <ion-icon name="reader-outline"></ion-icon>
              Additional Notes (Optional)
            </label>
            <ion-textarea formControlName="notes" placeholder="Add any additional context or notes about your work..."
              rows="4">
            </ion-textarea>
          </div> -->


        </form>
      </ion-card-content>
    </ion-card>

    <!-- ================= MY TIMESHEETS ================= -->
    <ion-card class="worklog-block timesheets-card">
      <ion-card-header>
        <div class="header-content">
          <div>
            <ion-card-title>
              <ion-icon name="calendar-outline"></ion-icon>
              My Timesheets
            </ion-card-title>
            <p>View and manage your submitted work logs</p>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>

        <!-- FILTERS -->
        <div class="filter-section">
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-label position="stacked">Month</ion-label>
                  <ion-select [value]="selectedMonth" (ionChange)="onMonthChange($event)" interface="popover"
                    toggleIcon="chevron-down" expandedIcon="chevron-up">
                    <ion-select-option *ngFor="let m of months" [value]="m.value">{{m.name}}</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-label position="stacked">Year</ion-label>
                  <ion-select [value]="selectedYear" (ionChange)="onYearChange($event)" interface="popover"
                    toggleIcon="chevron-down" expandedIcon="chevron-up">
                    <ion-select-option *ngFor="let y of years" [value]="y">{{y}}</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>

        <ion-spinner *ngIf="loadingList"></ion-spinner>

        <ion-grid class="table-block ion-no-padding" *ngIf="!loadingList && paginatedTimesheets.length">
          <ion-row class="table-header">
            <ion-col size="2">
              <p><ion-icon name="calendar"></ion-icon> Date</p>
            </ion-col>           
            <ion-col size="2">
              <p><ion-icon name="time"></ion-icon> Total Hours</p>
            </ion-col>
            <ion-col size="2">
              <p><ion-icon name="checkmark-circle"></ion-icon> Status</p>
            </ion-col>
            <ion-col size="4">
              <p><ion-icon name="document-text"></ion-icon> Remarks</p>
            </ion-col>
            <ion-col size="2">
              <p>Actions</p>
            </ion-col>            
          </ion-row>
          <ion-row class="table-list-row" *ngFor="let t of paginatedTimesheets">
            <ion-col size="2">
              {{ t.date | date }}
            </ion-col>          
            <ion-col size="2">
              {{ t.total_hours }}
            </ion-col>
            <ion-col size="2">
              <ion-badge [color]="getStatusColor(t.status)">{{ t.status || 'pending' | titlecase }}</ion-badge>
            </ion-col> 
            <ion-col size="4">
              No Remarks
            </ion-col>
            <ion-col size="2">
              <ion-button fill="clear" (click)="openPreview(t)">
                <ion-img src="../../../assets/Icons/Eye-blue.svg"></ion-img>
              </ion-button>

              <!-- EXCEL -->
              <ion-button fill="clear" (click)="downloadExcel(t)">
                <ion-img src="../../../assets/Icons/dowload-blue.svg"></ion-img>
              </ion-button>
            </ion-col>
             
          </ion-row>

        </ion-grid>

        <!-- PAGINATION -->
        <div class="pagination-controls" *ngIf="!loadingList && myTimesheets.length > itemsPerPage">
          <ion-button fill="clear" size="small" [disabled]="currentPage === 1" (click)="previousPage()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>

          <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>

          <ion-button fill="clear" size="small" [disabled]="currentPage === totalPages" (click)="nextPage()">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </div>

        <div class="no-leaves-img">
          <p *ngIf="!loadingList && !myTimesheets.length" class="empty-data ">
            <ion-img src="../../../assets/no_leavedata_img.svg"></ion-img>
            No timesheets found for {{ months[selectedMonth - 1]?.name }} {{ selectedYear }}
          </p>
        </div>


      </ion-card-content>
    </ion-card>

  </div>

  <div *ngIf="hasProject">

    <div class="project-banner">
      <ion-icon name="briefcase"></ion-icon>
      <span>You are assigned to a project</span>
    </div>

    <ion-card *ngFor="let a of assignments" class="worklog-block project-assignment-card ion-margin-bottom">
      <ion-card-content>
        <div class="project-info-grid">
          <div class="info-item">
            <ion-icon name="rocket-outline" color="primary"></ion-icon>
            <div>
              <label>Project Name</label>
              <p>{{ a.project_name }}</p>
            </div>
          </div>
          <div class="info-item">
            <ion-icon name="code-slash-outline" color="primary"></ion-icon>
            <div>
              <label>Project Code</label>
              <p>{{ a.project_code }}</p>
            </div>
          </div>
          <div class="info-item">
            <ion-icon name="business-outline" color="primary"></ion-icon>
            <div>
              <label>Client</label>
              <p>{{ a.client_name }}</p>
            </div>
          </div>
          <div class="info-item">
            <ion-icon name="time-outline" color="primary"></ion-icon>
            <div>
              <label>Shift</label>
              <p>{{ a.shift_name }}</p>
            </div>
          </div>
          <div class="info-item">
            <ion-icon name="alarm-outline" color="primary"></ion-icon>
            <div>
              <label>Working Hours</label>
              <p>{{ a.start_time }} - {{ a.end_time }}</p>
            </div>
          </div>
          <div class="info-item">
            <ion-icon name="calendar-outline" color="primary"></ion-icon>
            <div>
              <label>Duration </label>
              <p>{{ a.start_date | date:'mediumDate' }} to {{ a.end_date | date:'mediumDate' }}</p>
            </div>
          </div>
        </div>
        <!-- Client Timesheet Upload UI -->
        <div class="client-upload-block ion-margin-top">
          <ion-item lines="none" class="upload-file">
            <ion-label position="stacked">Upload Client Timesheet</ion-label>
            <div class="button-wrapper">
              <span class="label"> Upload File</span>
              <input type="file" id="upload" class="upload-box" (change)="onClientUploadFileChange($event)" accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png" />
          </div>
            </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Month</ion-label>
            <ion-select [(ngModel)]="clientUploadMonth" interface="popover"
            toggleIcon="chevron-down" expandedIcon="chevron-up">
              <ion-select-option *ngFor="let m of months" [value]="m.value">{{m.name}}</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item lines="none">
            <ion-label position="stacked">Year</ion-label>
            <ion-select [(ngModel)]="clientUploadYear" interface="popover"
            toggleIcon="chevron-down" expandedIcon="chevron-up">
              <ion-select-option *ngFor="let y of years" [value]="y">{{y}}</ion-select-option>
            </ion-select>
          </ion-item>
          <ion-button class="primary-btn ion-margin-top" (click)="uploadClientTimesheet(a.project_id)"
            [disabled]="!clientUploadFile || clientUploadLoading">
            <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
            {{ clientUploadLoading ? 'Uploading...' : 'Upload Client Timesheet' }}
          </ion-button>
          <ion-note *ngIf="clientUploadFile" color="success">
            Selected: {{clientUploadFile.name}}
          </ion-note>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- ================= MY PROJECT TIMESHEETS ================= -->
    <ion-card class="worklog-block timesheets-card">
      <ion-card-header>
        <div class="header-content">
          <div>
            <ion-card-title>
              <ion-icon name="documents-outline"></ion-icon>
              My Project Reports
            </ion-card-title>
            <p>View and manage your submitted project work reports</p>
          </div>
        </div>
      </ion-card-header>

      <ion-card-content>

        <!-- FILTERS -->
        <div class="filter-section">
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-label position="stacked">Month</ion-label>
                  <ion-select [value]="selectedMonth" (ionChange)="onMonthChange($event)" interface="popover"
                    toggleIcon="chevron-down" expandedIcon="chevron-up">
                    <ion-select-option *ngFor="let m of months" [value]="m.value">{{m.name}}</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
              <ion-col size="6">
                <ion-item lines="none">
                  <ion-label position="stacked">Year</ion-label>
                  <ion-select [value]="selectedYear" (ionChange)="onYearChange($event)" interface="popover"
                    toggleIcon="chevron-down" expandedIcon="chevron-up">
                    <ion-select-option *ngFor="let y of years" [value]="y">{{y}}</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>

        <ion-spinner *ngIf="loadingList"></ion-spinner>

        <ion-grid class="table-block ion-no-padding" *ngIf="!loadingList && paginatedTimesheets.length">
          <ion-row class="table-header">
            <ion-col size="2">
              <p><ion-icon name="calendar"></ion-icon> Date</p>
            </ion-col>
            <ion-col size="4">
              <p><ion-icon name="document-text"></ion-icon> Work Description</p>
            </ion-col>
            <ion-col size="2">
              <p><ion-icon name="time"></ion-icon> Total Hours</p>
            </ion-col>
            <ion-col size="2">
              <p><ion-icon name="checkmark-circle"></ion-icon> Status</p>
            </ion-col>
            <ion-col size="2">
              <p>Actions</p>
            </ion-col>
          </ion-row>
          <ion-row class="table-list-row" *ngFor="let t of paginatedTimesheets">
            <ion-col size="2">
              {{ t.date | date }}
            </ion-col>
            <ion-col size="4">
              {{ t.work_description || t.notes || 'No description' }}
            </ion-col>
            <ion-col size="2">
              {{ t.total_hours }}
            </ion-col>
            <ion-col size="2">
              <ion-badge [ngClass]="getStatusColor(t.status)">{{ t.status || 'pending' | titlecase }}</ion-badge>
            </ion-col>
            <ion-col size="2">
              <ion-button fill="clear" (click)="openPreview(t)">
                <ion-img src="../../../assets/Icons/Eye-blue.svg"></ion-img>
              </ion-button>

              <!-- EXCEL -->
              <ion-button fill="clear" (click)="downloadExcel(t)">
                <ion-img src="../../../assets/Icons/dowload-blue.svg"></ion-img>
              </ion-button>
            </ion-col>
          </ion-row>

        </ion-grid>

        <!-- PAGINATION -->
        <div class="pagination-controls" *ngIf="!loadingList && myTimesheets.length > itemsPerPage">
          <ion-button fill="clear" size="small" [disabled]="currentPage === 1" (click)="previousPage()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>

          <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>

          <ion-button fill="clear" size="small" [disabled]="currentPage === totalPages" (click)="nextPage()">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </div>

        <div class="no-leaves-img">
          <p *ngIf="!loadingList && !myTimesheets.length" class="empty-data ">
            <ion-img src="../../../assets/no_leavedata_img.svg"></ion-img>
            No timesheets found for {{ months[selectedMonth - 1]?.name }} {{ selectedYear }}
          </p>
        </div>

      </ion-card-content>
    </ion-card>

  </div>





</ion-content>